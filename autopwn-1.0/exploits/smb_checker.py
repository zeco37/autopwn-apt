# exploits/smb_checker.py

import nmap
from core.storage import results

def check_smb_vuln(target_ip):
    print(f"[*] Vérification des vulnérabilités SMB sur {target_ip}...")

    try:
        nm = nmap.PortScanner()
        nm.scan(target_ip, arguments="--script smb-vuln* -p 139,445")

        output_lines = []

        # Résultats par script
        if "hostscript" in nm[target_ip]:
            for script in nm[target_ip]["hostscript"]:
                output_lines.append(f"{script['id']} : {script['output']}")

        # Résultats par port
        for proto in nm[target_ip].all_protocols():
            for port in nm[target_ip][proto]:
                scripts = nm[target_ip][proto][port].get("script", {})
                for script_name, result in scripts.items():
                    output_lines.append(f"{script_name} (port {port}): {result}")

        if output_lines:
            print("[+] Vulnérabilités détectées :")
            for line in output_lines:
                print(f"  - {line}")
                results["smb"].append(line)
        else:
            print("[✓] Aucun script de vulnérabilité SMB n'a retourné de résultat.")
            results["smb"].append("Aucune vulnérabilité SMB détectée (résultat vide).")

    except Exception as e:
        print(f"[!] Erreur pendant le scan SMB : {e}")
        results["smb"].append(f"Erreur SMB : {e}")
